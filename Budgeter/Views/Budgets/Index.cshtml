@model IEnumerable<Budgeter.Models.Budget>
@using Budgeter.Helper

<div class="row" style="display:flex; align-items:center">
    <div class="col-md-6">
        <h3>@ViewBag.household.Name Budget Items</h3>
    </div>
    <div class="col-md-4">
        <button class="btn btn-info" data-target="#BudgetCreateModal" data-toggle="modal"><i class="fa fa-plus-square" aria-hidden="true"></i> Add a new Budget Category</button>
    </div>
</div>
<hr />

@foreach(var item in Model)
{
    <div class="col-md-4">
        <div class="panel panel-info">
            <input style="display:none;" value="@item.Id" id="BudgetId" />
            <div class="panel-heading">
                <h4 class="panel-title" style="text-align:center;">@item.Name</h4>
                <div class="text-info" style="text-align:center;">Allocated Budget: $@item.Amount</div>
            </div>
            <div class="panel-body">
                @foreach(var budgetItem in item.BudgetItems.ToList())
                {
                    <div class="row">
                        <div class="col-md-7">
                            @budgetItem.Name
                        </div>
                        <div class="col-md-5">
                            Spent: $@BudgetHelper.BudgetItemExpense(budgetItem.Id)
                        </div>
                    </div>
                }
            </div>
            <div class="panel-footer panel-info" style="display:flex; justify-content:center;">
                <div class="btn-group">
                    <button class="btn btn-danger deleteBudgetButton" data-toggle="modal" data-target="DeleteBudgetModal">Delete</button>
                    <button class="btn btn-warning" data-toggle="modal" data-target="">Edit</button>
                    <button class="btn btn-success" data-toggle="modal" data-target="">Add New Item</button>
                </div>
            </div>
        </div>
    </div>
}

<!--Create new Budget Modal-->

@using(Html.BeginForm("create","Budgets", FormMethod.Post, new { @class = "form-inline", id="BudgetCreateForm" }))
{
    @Html.AntiForgeryToken()
    <div id="BudgetCreateModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Create a New Budget Category</h4>
                </div>
                <div class="modal-body">
                    <h5 style="text-align:center;" class="text-info">Give Your New Category a Name and set its Budget Limit.</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" name="Name" pattern="[\w\s]+" title="alphanumeric" maxlength="30" class="form-control" placeholder="Name" required style="width:183px;" />
                        </div>
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-addon"><i class="fa fa-usd" aria-hidden="true"></i></span>
                                <input type="text" name="Amount" pattern="[0-9]+(\.[0-9][0-9]?)?" title="Dollars and Cents" class="form-control" required style="width:150px;" placeholder="Budget Limit" />
                            </div>
                        </div>
                    </div>
                    <br />
                    <h5 style="text-align:center" class="text-info">Add Items by Typing a Name and Clicking the <button type="button" class="btn btn-success btn-social-icon"><i class="fa fa-plus" aria-hidden="true"></i></button> Button<br />(Note: A Category Without Items Can't Have Transactions)</h5>
                    <div class="input-group">
                        <div class="input-group-btn">
                            <button class="btn btn-success" id="createBudgetItem1" type="button"><i class="fa fa-plus" aria-hidden="true"></i></button>
                        </div>
                        <input type="text" id="budgetItemInpu1" maxlength="30" class="form-control" placeholder="Item Name" style="width:183px;" />
                    </div>
                    <div style="text-align:center" class="text-success">Items Added: <strong id="budgetItemList"></strong> </div>
                </div>
                <div class="modal-footer" style="display:flex; justify-content:center;">
                    <button class="btn btn-success btn-lg" id="BudgetFormSubmit" type="submit"><i class="fa fa-plus-square" aria-hidden="true"> Create Budget Category</i></button>
                </div>
            </div>
        </div>
    </div>
}

<!---Delete Budget Modal-->

<div class="modal fade" role="dialog" id="DeleteBudgetModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Delete a Budget/Budget Item</h4>
            </div>
            <div class="modal-body">
                @using(Html.BeginForm("delete","budgets", new { returnUrl = Request.Url.AbsoluteUri },FormMethod.Post, new {id = "DeleteBudgetForm" }))
                {
                    @Html.AntiForgeryToken()
                    <h3 class="text-warning" style="text-align:center" id="DeleteBudgetName"></h3>
                    <p class="text-danger" style="text-align:center;">Warning: Deleting this Category will Also Delete all Budget Items Attached to it.</p>
                    <div style="display:flex; justify-content:center">
                        <button type="submit" class="btn btn-danger btn-large" name="id" id="deleteBudgetButton2" value=""><i class="fa fa-times" aria-hidden="true"></i> Delete Category</button>
                    </div>
                }
                <hr />
                @using(Html.BeginForm("delete","budgetitems", new { returnUrl = Request.Url.AbsoluteUri }, FormMethod.Post, new { id = "deleteBudgetItemForm"}))
                {
                    @Html.AntiForgeryToken()
                    <h4 class="text-warning" style="text-align:center">Select Which Items You want to Delete</h4>
                    <br />
                    <div id="BudgetItemDeleteListDropdown" style="display:flex; justify-content:center">

                    </div>
                    <br />
                    <div style="display:flex; justify-content:center">
                        <button type="submit" class="btn btn-danger btn-large" id="deleteBudgetItems"><i class="fa fa-times" aria-hidden="true"></i> Delete Items</button>
                    </div>
                }   
            </div>
        </div>
    </div>
</div>


@section Scripts {
<!---Script for displaying Budget Items-->
    <script>
        var itemSet = [];
        $('#createBudgetItem1').click(function () {
            if ($('#budgetItemInpu1').val().trim(" ") != "") {
                itemSet.push($('#budgetItemInpu1').val());
            };
            for (i = 0; i < itemSet.length; i++) {
                if (i == 0) {
                    $('#budgetItemList').html(itemSet[i]);
                }
                else {
                    $('#budgetItemList').append(', ' + itemSet[i])
                }
            }
            $('#budgetItemInpu1').val("")
            $('#BudgetCreateForm').prop('action', 'Budgets/create?householdId=' + '@ViewBag.household.Id' + '&budgetItems=' + itemSet + '&returnUrl=' + '@Request.Url.AbsoluteUri')
        });
    </script>
<!-----DeleteBudgetModal-->
    <script>
        var currentPanel;
        var budgetIdJs
        $('.deleteBudgetButton').click(function () {
            $('#deleteBudgetItemForm').find('#BudgetItemDeleteListDropdown').empty();
            currentPanel = $(this).parents('div.panel.panel-info')
            budgetIdJs = currentPanel.children('#BudgetId').val()
            $.ajax({
                url: '/Budgets/delete/',
                data: {
                    id: budgetIdJs
                },
                type: 'GET',
                dataType: "json",
            })
            .done(function (json) {
                $('#DeleteBudgetName').html(json.name);
                $('#deleteBudgetButton2').val(budgetIdJs);
                for (i = 0; i < json.budgetItemNamesList.length; i++) {
                    if (i == 0) {
                        $('#BudgetItemDeleteListDropdown').append("<select multiple id='budgetItemsSelectDelete' name='Ids'><option value=" + json.budgetItemIdsList[i] + ">" + json.budgetItemNamesList[i] + "</option></select>")
                    }
                    else {
                        $('#budgetItemsSelectDelete').append("<option value=" + json.budgetItemIdsList[i] + ">" + json.budgetItemNamesList[i] + "</option>")
                    }
                };
                $('#budgetItemsSelectDelete').multiSelect({
                    selectableHeader: "<div class='custom-header' style='text-align:center; font-size:1.2em'>Available</div>",
                    selectionHeader: "<div class='custom-header' style='text-align:center; font-size:1.2em'>Delete</div>"
                });
                $('#DeleteBudgetModal').modal('toggle');
            })
        });
    </script>
}

